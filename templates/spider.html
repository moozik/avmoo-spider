{% extends "main.html" %}

{% block title %} 爬虫 {% endblock %}
{% block container %}
<style>
    .avatar-box{
        height:290px;
    }
</style>
<div class="container-fluid">
    <div class="row">
        <div id="waterfall">
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <form class="" style="width:500px;" action="/action/crawl" method="post">
                <div class="form-group">
                    <textarea class="form-control" name="url_text" placeholder="完整链接,例:
https://avmoo.sbs/cn/movie/9fed39545dc47840
https://avmoo.sbs/cn/star/26532bc87b4ce1d1/page/2
https://avmoo.sbs/cn/genre/dd21aefe7ae3228c
https://avmoo.sbs/cn/studio/ce25ddc3a9caca20
https://avmoo.sbs/cn/label/8eab1a64464779ff
https://avmoo.sbs/cn/director/63a8f4da6e22cc09
https://avmoo.sbs/cn/search/ABP/page/25" style="width: 500px;height: 200px;" title="url text"></textarea>
                </div>
                <div class="form-group">
                    <label title="crawl pagenum limit">最大抓取页数</label>
                    <input type="text" class="form-control" name="crawl_pagenum_limit" value="100"/>
                </div>
                <button type="submit" class="btn btn-default" title="crawl by whole link">下载指定链接</button>
            </form>
        </div>
        <div class="col-md-4">
            <h4 title="work list">等待中任务</h4>
            <div>
                <ul id="queue_list">
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
function frash_last_insert_list(){
    $.getJSON("/action/last/insert", function(data){
        console.log(data);

        $("#waterfall").html("");
        data["last_insert_list"].forEach(item => {
            $("#waterfall").append(
                '<div class="item" style="position: relative;">'+
                    '<a class="movie-box" href="/movie/' + item.linkid + '" target="_blank">'+
                        '<div class="photo-frame">'+
                            '<img src="{{config["website"]["cdn"]}}' + '/digital/video' + item.bigimage.replace("pl.", "ps.") + '">'+
                        '</div>'+
                        '<div class="photo-info">'+
                            '<span>' + item.title +
                                '<br>'+
                                '<date>' + item.av_id + '</date> /'+
                                '<date>' + item.release_date + '</date>'+
                            '</span>'+
                        '</div>'+
                        '<div class="movie-desc">'+
                            item.genre + '<br><br>'+
                            item.stars + '<br><br>'+
                            'len:<b style="color:red;">'+item.len+'min</b> image:<b style="color:red;">'+item.image_len+'</b>'+
						'</div>'+
                    '</a>'+
                '</div>'
            );
        });
        $("#queue_list").html("");
        data["queue_list"].forEach(item => {
            $("#queue_list").append(
                '<li>' +
                    '<a href="'+item.url+'" target="_blank">'+item.url+'</a>'+ (item.page_limit > 0? ' page_limit:'+item.page_limit:'') +
                '</li>'
            );
        });
    });
}
frash_last_insert_list()
setInterval(frash_last_insert_list, 20000);
</script>
{% endblock %}